<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>頭痛日記</title>
  <style>
    :root{--small:#FFD966;--medium:#FFA500;--large:#FF6161;--cell-size:80px;font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Noto Sans TC", "Microsoft JhengHei", sans-serif}
    body{margin:18px}
    header{display:flex;align-items:center;gap:12px;margin-bottom:12px}
    h1{font-size:20px;margin:0}
    .controls{display:flex;gap:8px;align-items:center}
    button{padding:6px 10px;border-radius:6px;border:1px solid #ccc;background:#fff;cursor:pointer}
    .calendar{display:grid;grid-template-columns:repeat(7,1fr);gap:6px}
    .weekday{font-weight:600;text-align:center}
    .cell{height:var(--cell-size);border-radius:8px;border:1px solid #e6e6e6;padding:6px;box-sizing:border-box;display:flex;flex-direction:column;justify-content:space-between}
    .date{font-size:13px}
    .dot{width:100%;height:8px;border-radius:6px;margin-top:6px}
    .legend{display:flex;gap:8px;margin-top:10px;align-items:center}
    .legend span{display:inline-flex;align-items:center;gap:6px}
    .dotbox{width:14px;height:14px;border-radius:3px}
    .modal{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.35);}
    .card{background:#fff;padding:16px;border-radius:10px;width:520px;max-width:95%;max-height:90%;overflow:auto}
    .form-row{display:flex;gap:8px;align-items:center;margin-bottom:8px}
    label{min-width:120px}
    input[type="number"], input[type="time"], select, textarea{flex:1;padding:6px;border:1px solid #ccc;border-radius:6px}
    .checkbox-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:6px}
    .small{font-size:13px;color:#666}
    .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:10px}
    .import-export{margin-left:auto}
    .empty{color:#999;text-align:center;padding:18px}
    .cell:hover{box-shadow:0 2px 6px rgba(0,0,0,0.08)}
  </style>
</head>
<body>
  <header>
    <h1>頭痛日記</h1>
    <div class="controls">
      <button id="prev">◀</button>
      <div id="monthLabel" style="min-width:160px;text-align:center"></div>
      <button id="next">▶</button>
      <div class="import-export">
        <button id="exportBtn">匯出 JSON</button>
        <button id="importBtn">匯入 JSON</button>
        <input id="importFile" type="file" accept="application/json" style="display:none" />
      </div>
    </div>
  </header>

  <div class="calendar" id="calendar"></div>
  <div class="legend">
    <span><span class="dotbox" style="background:var(--small)"></span>小痛</span>
    <span><span class="dotbox" style="background:var(--medium)"></span>中痛</span>
    <span><span class="dotbox" style="background:var(--large)"></span>大痛</span>
    <span class="small">（未紀錄不上色，點日期可新增或檢視當日記錄）</span>
  </div>

  <template id="cellTemplate">
    <div class="cell">
      <div class="date"></div>
      <div class="dot"></div>
    </div>
  </template>

  <!-- Modal -->
  <div id="modal" style="display:none" class="modal">
    <div class="card">
      <h3 id="modalTitle">新增頭痛記錄</h3>
      <div class="form-row"><label>日期時間</label><input id="datetime" type="datetime-local"></div>

      <div class="form-row"><label>頭痛程度</label>
        <select id="severity">
          <option value="">未選</option>
          <option value="1">1：小痛</option>
          <option value="2">2：中痛</option>
          <option value="3">3：大痛</option>
        </select>
      </div>

      <div class="form-row"><label>伴隨症狀</label>
        <div style="flex:1">
          <div class="checkbox-grid">
            <label><input type="checkbox" value="噁心嘔吐" class="symptom"> 噁心嘔吐</label>
            <label><input type="checkbox" value="怕光怕吵" class="symptom"> 怕光怕吵</label>
            <label><input type="checkbox" value="單側開始" class="symptom"> 單側開始</label>
            <label><input type="checkbox" value="搏動性頭痛" class="symptom"> 搏動性頭痛</label>
            <label><input type="checkbox" value="因活動加劇" class="symptom"> 因活動加劇</label>
            <label><input type="checkbox" value="其他" id="symptomOtherChk" class="symptom"> 其他</label>
          </div>
          <div style="margin-top:6px"><input id="symptomOtherTxt" placeholder="其他症狀備註" disabled></div>
        </div>
      </div>

      <div class="form-row"><label>持續時間（小時）</label><input id="duration" type="number" min="0" step="0.1" placeholder="例如: 2.5"></div>

      <div class="form-row"><label>服用急性藥物</label>
        <div style="flex:1">
          <label><input type="checkbox" value="止痛藥" class="med"> 止痛藥</label>
          <label style="margin-left:12px"><input type="checkbox" value="其他" id="medOtherChk" class="med"> 其他</label>
          <div style="margin-top:6px"><input id="medOtherTxt" placeholder="其他藥物備註" disabled></div>
        </div>
      </div>

      <div class="form-row"><label>藥物有效</label><input id="medEffective" type="checkbox"></div>
      <div class="form-row"><label>是否影響生活</label><input id="affectLife" type="checkbox"></div>
      <div class="form-row"><label>是否生理期</label><input id="onPeriod" type="checkbox"></div>

      <div class="form-row"><label>備註</label><textarea id="notes" rows="3"></textarea></div>

      <div class="actions">
        <button id="deleteBtn" style="background:#fff">刪除</button>
        <button id="cancelBtn">取消</button>
        <button id="saveBtn">儲存</button>
      </div>
    </div>
  </div>

  <script>
    // storage key
    const STORAGE_KEY = 'headache_diary_v1';

    function loadEntries(){
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return {};
      try{
        const parsed = JSON.parse(raw);
        if(typeof parsed === 'object' && parsed !== null) return parsed;
        console.warn('storage parsed but not object, resetting');
        return {};
      }catch(e){
        console.error('loadEntries parse error', e);
        // do not overwrite storage here; return empty and allow user to export raw for debugging
        return {};
      }
    }

    function saveEntries(obj){
      try{
        localStorage.setItem(STORAGE_KEY, JSON.stringify(obj));
        // for debugging in case user reports problems
        // console.log('saved entries', Object.keys(obj).length);
        return true;
      }catch(e){
        console.error('saveEntries failed', e);
        alert('儲存失敗：' + e.message);
        return false;
      }
    }

    // entries is always an object mapping id -> entry
    let entries = loadEntries();

    // calendar state
    let viewDate = new Date();
    const calendarEl = document.getElementById('calendar');
    const monthLabel = document.getElementById('monthLabel');

    document.getElementById('prev').addEventListener('click', ()=>{ viewDate.setMonth(viewDate.getMonth()-1); renderCalendar(); });
    document.getElementById('next').addEventListener('click', ()=>{ viewDate.setMonth(viewDate.getMonth()+1); renderCalendar(); });

    // export: produce array with id included (more interoperable)
    document.getElementById('exportBtn').addEventListener('click', ()=>{
      try{
        const arr = Object.entries(entries).map(([id,entry])=>({id, ...entry}));
        const blob = new Blob([JSON.stringify(arr, null, 2)], {type:'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = 'headache_diary.json'; a.click(); URL.revokeObjectURL(url);
      }catch(e){
        alert('匯出失敗：' + e.message);
      }
    });

    const importFile = document.getElementById('importFile');
    document.getElementById('importBtn').addEventListener('click', ()=>importFile.click());
    importFile.addEventListener('change', async (e)=>{
      const f = e.target.files[0]; if(!f) return;
      try{
        const txt = await f.text();
        const data = JSON.parse(txt);
        // accept either array or object
        let incoming = {};
        if(Array.isArray(data)){
          data.forEach(item=>{
            const id = item.id || ('id_' + (Date.now()) + '_' + Math.random().toString(36).slice(2,8));
            // clone without id
            const copy = {...item}; delete copy.id; incoming[id] = copy;
          });
        }else if(typeof data === 'object' && data !== null){
          // assume it's same shape as storage (id -> entry)
          incoming = data;
        }else{
          throw new Error('不支援的 JSON 格式');
        }
        // merge but avoid overwriting existing keys unless id is same; we'll add new keys
        Object.entries(incoming).forEach(([k,v])=>{
          // if k conflicts, create new id to avoid silent overwrite
          if(entries[k]){
            const newId = 'id_' + Date.now() + '_' + Math.random().toString(36).slice(2,8);
            entries[newId] = v;
          }else{
            entries[k] = v;
          }
        });
        const ok = saveEntries(entries);
        if(ok){ renderCalendar(); alert('已匯入並合併紀錄'); }
      }catch(err){ alert('匯入失敗：'+err.message); }
      importFile.value='';
    });

    function startOfWeek(d){ const dt = new Date(d); const day = dt.getDay(); dt.setDate(dt.getDate() - day); dt.setHours(0,0,0,0); return dt; }
    function formatISODate(d){ const y=d.getFullYear(); const m=('0'+(d.getMonth()+1)).slice(-2); const day=('0'+d.getDate()).slice(-2); return `${y}-${m}-${day}`; }

    function renderCalendar(){
      calendarEl.innerHTML='';
      const year = viewDate.getFullYear(); const month = viewDate.getMonth();
      monthLabel.textContent = `${year} 年 ${month+1} 月`;
      const wds = ['日','一','二','三','四','五','六'];
      wds.forEach(w=>{ const el = document.createElement('div'); el.className='weekday'; el.textContent=w; calendarEl.appendChild(el); });

      const first = new Date(year, month, 1);
      const start = startOfWeek(first);
      for(let i=0;i<42;i++){
        const d = new Date(start); d.setDate(start.getDate()+i);
        const iso = formatISODate(d);
        const tpl = document.getElementById('cellTemplate');
        const node = tpl.content.firstElementChild.cloneNode(true);
        node.querySelector('.date').textContent = `${d.getDate()} ${d.getMonth()===month?'':'(非本月)'}`;
        const dot = node.querySelector('.dot');
        const dayEntries = Object.values(entries).filter(en=>en.date && en.date.startsWith(iso));
        if(dayEntries.length>0){
          const worst = Math.max(...dayEntries.map(e=>Number(e.severity||0)));
          if(worst===1) dot.style.background='var(--small)';
          if(worst===2) dot.style.background='var(--medium)';
          if(worst===3) dot.style.background='var(--large)';
        }else{
          dot.style.background='transparent';
        }
        node.addEventListener('click', ()=>openDayView(iso, d));
        calendarEl.appendChild(node);
      }
    }

    // modal form logic
    const modal = document.getElementById('modal');
    const datetimeInput = document.getElementById('datetime');
    const severityEl = document.getElementById('severity');
    const symptomOtherChk = document.getElementById('symptomOtherChk');
    const symptomOtherTxt = document.getElementById('symptomOtherTxt');
    const medOtherChk = document.getElementById('medOtherChk');
    const medOtherTxt = document.getElementById('medOtherTxt');
    const deleteBtn = document.getElementById('deleteBtn');
    const saveBtn = document.getElementById('saveBtn');
    const cancelBtn = document.getElementById('cancelBtn');

    symptomOtherChk.addEventListener('change', ()=>{ symptomOtherTxt.disabled=!symptomOtherChk.checked; if(!symptomOtherChk.checked) symptomOtherTxt.value=''; });
    medOtherChk.addEventListener('change', ()=>{ medOtherTxt.disabled=!medOtherChk.checked; if(!medOtherChk.checked) medOtherTxt.value=''; });
    cancelBtn.addEventListener('click', ()=>{ closeModal(); });

    let editingId = null; // key in entries

    function openDayView(isoDate, dateObj){
      editingId = null;
      document.getElementById('modalTitle').textContent = `紀錄：${isoDate}`;
      const nowStr = isoDate + 'T12:00';
      datetimeInput.value = nowStr;
      severityEl.value='';
      document.querySelectorAll('.symptom').forEach(ch=>ch.checked=false);
      symptomOtherTxt.value=''; symptomOtherTxt.disabled=true; symptomOtherChk.checked=false;
      document.querySelectorAll('.med').forEach(ch=>ch.checked=false); medOtherTxt.value=''; medOtherTxt.disabled=true; medOtherChk.checked=false;
      document.getElementById('duration').value='';
      document.getElementById('medEffective').checked=false;
      document.getElementById('affectLife').checked=false;
      document.getElementById('onPeriod').checked=false;
      document.getElementById('notes').value='';

      const dayEntries = Object.entries(entries).filter(([k,v])=> v.date && v.date.startsWith(isoDate));
      if(dayEntries.length>0){
        // show the first one for editing
        const [id, data] = dayEntries[0];
        editingId = id;
        datetimeInput.value = data.date;
        severityEl.value = data.severity||'';
        if(Array.isArray(data.symptoms)){
          document.querySelectorAll('.symptom').forEach(ch=>{ ch.checked = data.symptoms.includes(ch.value); });
          if(data.symptoms.includes('其他')){ symptomOtherChk.checked=true; symptomOtherTxt.disabled=false; symptomOtherTxt.value = data.symptomOther || ''; }
        }
        document.getElementById('duration').value = data.duration||'';
        if(Array.isArray(data.medications)){
          document.querySelectorAll('.med').forEach(ch=>{ ch.checked = data.medications.includes(ch.value); });
          if(data.medications.includes('其他')){ medOtherChk.checked=true; medOtherTxt.disabled=false; medOtherTxt.value = data.medOther || ''; }
        }
        document.getElementById('medEffective').checked = !!data.medEffective;
        document.getElementById('affectLife').checked = !!data.affectLife;
        document.getElementById('onPeriod').checked = !!data.onPeriod;
        document.getElementById('notes').value = data.notes||'';
      }

      deleteBtn.style.display = editingId ? 'inline-block' : 'none';
      modal.style.display='flex';
      window.scrollTo(0,0);
    }

    deleteBtn.addEventListener('click', ()=>{
      if(!editingId) return;
      if(!confirm('確定刪除此筆紀錄？')) return;
      delete entries[editingId];
      saveEntries(entries); renderCalendar(); closeModal();
    });

    saveBtn.addEventListener('click', ()=>{
      const data = {};
      const dt = datetimeInput.value; if(!dt){ alert('請選擇日期時間'); return; }
      data.date = dt;
      data.severity = severityEl.value;
      const symptoms = Array.from(document.querySelectorAll('.symptom')).filter(ch=>ch.checked).map(ch=>ch.value);
      data.symptoms = symptoms;
      if(symptoms.includes('其他')) data.symptomOther = symptomOtherTxt.value.trim();
      data.duration = document.getElementById('duration').value;
      const meds = Array.from(document.querySelectorAll('.med')).filter(ch=>ch.checked).map(ch=>ch.value);
      data.medications = meds;
      if(meds.includes('其他')) data.medOther = medOtherTxt.value.trim();
      data.medEffective = document.getElementById('medEffective').checked;
      data.affectLife = document.getElementById('affectLife').checked;
      data.onPeriod = document.getElementById('onPeriod').checked;
      data.notes = document.getElementById('notes').value.trim();

      const key = editingId || ('id_' + Date.now() + '_' + Math.random().toString(36).slice(2,8));
      entries[key] = data;
      const ok = saveEntries(entries);
      if(ok){ renderCalendar(); closeModal(); }
    });

    function closeModal(){ modal.style.display='none'; editingId=null; }

    // initial render
    renderCalendar();

    // debug helper: expose to console
    window._headache_entries = entries;
    window._saveEntries = saveEntries;
  </script>
</body>
</html>
